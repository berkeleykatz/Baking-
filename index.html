<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Recipe Collection</title>

  <!-- Tailwind (optional utilities for layout/spacing) -->
  <script src="https://cdn.tailwindcss.com" defer></script>

  <!-- Tesseract.js for client-side OCR -->
  <script src="https://unpkg.com/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f; --text:#5d4037; --primary:#ff6f61; --secondary:#4caf50;
      --surface:#ffffff; --accent:#ffe0b2; --accentText:#e65100;
    }
    html,body{height:100%}
    *{box-sizing:border-box}
    body{
      margin:0; font-family: Georgia, serif; color:var(--text);
      background:linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 100%);
      min-height:100%;
    }
    .container{max-width:1200px;margin:0 auto;padding:2rem}
    .header{text-align:center;margin-bottom:2rem}
    .header h1{font-size:2.5rem;margin:0 0 .5rem;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;
      border:none;border-radius:999px;padding:.75rem 1.25rem;font-weight:700;cursor:pointer;transition:.2s}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{filter:brightness(.95);transform:translateY(-1px)}
    .btn-secondary{background:var(--secondary);color:#fff}
    .btn-secondary:hover{filter:brightness(.95)}
    .btn-ghost{background:#fff;border:2px solid var(--text);color:var(--text);border-radius:20px;padding:.5rem 1rem}
    .btn-ghost.active,.btn-ghost:hover{background:var(--text);color:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.25rem}
    .card{background:var(--surface);border-radius:16px;padding:1.25rem;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    .chip{background:var(--accent);color:var(--accentText);padding:.25rem .6rem;border-radius:14px;font-weight:700;font-size:.8rem}
    .rating{display:flex;gap:.25rem;margin:.5rem 0 1rem}
    .star{font-size:1.4rem;cursor:pointer;transition:transform .15s}
    .star:hover{transform:scale(1.2)}
    .star.filled{color:#ffd700}.star.empty{color:#ddd}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:2rem;z-index:50}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:16px;padding:1.5rem;max-width:900px;width:100%;max-height:90%;overflow:auto}
    .form{display:grid;gap:1rem}
    .form label{font-weight:700;margin-bottom:.35rem;display:block}
    .input,.select,.textarea{width:100%;padding:.75rem;border:2px solid #ddd;border-radius:8px;font:inherit}
    .textarea{min-height:110px;resize:vertical}
    .limit{background:#fff3cd;border:2px solid #ffc107;color:#7a5d00;padding:1rem;border-radius:10px;text-align:center;font-weight:700;margin:1rem 0}
    .thumb{max-width:150px;max-height:100px;border-radius:8px;display:block;margin-top:.5rem;object-fit:cover}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>My Recipe Collection</h1>
      <p>Organize and rate your favorite baking recipes</p>
    </div>

    <div id="limit" class="limit" style="display:none">Maximum limit of 999 recipes reached.</div>

    <div class="flex flex-wrap items-center gap-3 mb-6">
      <button id="addBtn" class="btn btn-primary">‚ûï Add New Recipe</button>
      <div class="flex flex-wrap gap-2">
        <button class="btn-ghost active" data-filter="all">All</button>
        <button class="btn-ghost" data-filter="Cakes">üéÇ Cakes</button>
        <button class="btn-ghost" data-filter="Cookies">üç™ Cookies</button>
        <button class="btn-ghost" data-filter="Pies">ü•ß Pies</button>
        <button class="btn-ghost" data-filter="Bread">üçû Bread</button>
        <button class="btn-ghost" data-filter="Other">Other</button>
      </div>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="flex items-center justify-between mb-4">
        <h2 id="modalTitle" class="text-2xl m-0">Add New Recipe</h2>
        <button id="closeModal" class="btn-ghost">‚úï</button>
      </div>

      <form id="form" class="form">
        <div>
          <label for="name">Recipe Name</label>
          <input id="name" class="input" type="text" required placeholder="e.g., Chocolate Chip Cookies">
        </div>

        <div>
          <label for="cat">Category</label>
          <select id="cat" class="select" required>
            <option value="">Select a category</option>
            <option value="Cakes">Cakes</option>
            <option value="Cookies">Cookies</option>
            <option value="Pies">Pies</option>
            <option value="Bread">Bread</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div>
          <label for="ingredients">Ingredients</label>
          <textarea id="ingredients" class="textarea" required placeholder="One per line"></textarea>
        </div>

        <div>
          <label for="instructions">Instructions</label>
          <textarea id="instructions" class="textarea" required placeholder="Step-by-step"></textarea>
        </div>

        <!-- OCR from image -->
        <div>
          <label for="photo">Upload recipe photo (scan to fill form)</label>
          <input id="photo" type="file" accept="image/*" class="input">
          <img id="photoPreview" class="thumb" style="display:none" alt="Recipe photo preview">
          <div class="mt-2 flex items-center gap-2">
            <button id="scanBtn" type="button" class="btn btn-secondary">Scan Photo</button>
            <span id="scanProgress" class="text-sm"></span>
          </div>
        </div>

        <!-- OCR from video -->
        <div>
          <label for="video">Upload video (sample frames to OCR)</label>
          <input id="video" type="file" accept="video/*" class="input">
          <div class="mt-2 flex items-center gap-2">
            <button id="analyzeBtn" type="button" class="btn btn-secondary">Analyze Video</button>
            <span id="analyzeProgress" class="text-sm"></span>
          </div>
        </div>

        <!-- Finished photo shown on card -->
        <div>
          <label for="finished">Upload finished-photo (shown above recipe)</label>
          <input id="finished" type="file" accept="image/*" class="input">
          <img id="finishedPreview" class="thumb" style="display:none" alt="Finished photo preview">
        </div>

        <div class="grid grid-cols-2 gap-3 mt-2">
          <button id="cancelBtn" type="button" class="btn btn-ghost">Cancel</button>
          <button id="saveBtn" type="submit" class="btn btn-primary">Save Recipe</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Hidden elements for video OCR -->
  <video id="hiddenVideo" style="display:none"></video>
  <canvas id="canvas" style="display:none"></canvas>

  <script>
    /************ Simple data store (localStorage) ************/
    const STORE_KEY = 'recipes_v1';
    const load = () => { try { return JSON.parse(localStorage.getItem(STORE_KEY)) || []; } catch { return []; } };
    const save = (arr) => localStorage.setItem(STORE_KEY, JSON.stringify(arr));

    /************ App state ************/
    let recipes = load();        // array of recipe objects
    let filter = 'all';          // current category filter
    let editingId = null;        // __id of recipe being edited

    /************ DOM helpers ************/
    const $ = (sel) => document.querySelector(sel);
    const grid = $('#grid');
    const limit = $('#limit');
    const modal = $('#modal');
    const form = $('#form');
    const modalTitle = $('#modalTitle');
    const nameEl = $('#name');
    const catEl = $('#cat');
    const ingEl = $('#ingredients');
    const instEl = $('#instructions');
    const finishedEl = $('#finished');
    const finishedPreview = $('#finishedPreview');
    const photoEl = $('#photo');
    const photoPreview = $('#photoPreview');
    const scanBtn = $('#scanBtn');
    const scanProgress = $('#scanProgress');
    const videoEl = $('#video');
    const analyzeBtn = $('#analyzeBtn');
    const analyzeProgress = $('#analyzeProgress');

    /************ UI wiring ************/
    $('#addBtn').addEventListener('click', () => openAdd());
    $('#closeModal').addEventListener('click', closeModal);
    $('#cancelBtn').addEventListener('click', closeModal);
    document.querySelectorAll('[data-filter]').forEach(b => {
      b.addEventListener('click', (e) => {
        document.querySelectorAll('[data-filter]').forEach(x => x.classList.remove('active'));
        e.currentTarget.classList.add('active');
        filter = e.currentTarget.getAttribute('data-filter');
        render();
      });
    });

    photoEl.addEventListener('change', () => previewImage(photoEl, photoPreview));
    finishedEl.addEventListener('change', () => previewImage(finishedEl, finishedPreview));

    scanBtn.addEventListener('click', async () => {
      const f = photoEl.files && photoEl.files[0];
      if (!f) return alert('Choose a recipe photo first.');
      scanProgress.textContent = 'Scanning...';
      try {
        const text = await ocrFile(f, p => { scanProgress.textContent = `Scanning ${Math.round(p*100)}%`; });
        const parsed = parseText(text);
        if (parsed.name) nameEl.value = parsed.name;
        if (parsed.ingredients) ingEl.value = parsed.ingredients;
        if (parsed.instructions) instEl.value = parsed.instructions;
        scanProgress.textContent = 'Done.';
      } catch (e) {
        console.error(e);
        scanProgress.textContent = 'Failed to scan.';
        alert('OCR failed. Try a clearer photo.');
      } finally {
        setTimeout(() => scanProgress.textContent = '', 1200);
      }
    });

    analyzeBtn.addEventListener('click', async () => {
      const f = videoEl.files && videoEl.files[0];
      if (!f) return alert('Choose a video first.');
      try {
        analyzeProgress.textContent = 'Preparing video...';
        const text = await ocrVideo(f, (s) => analyzeProgress.textContent = s);
        const parsed = parseText(text);
        if (parsed.name) nameEl.value = parsed.name;
        if (parsed.ingredients) ingEl.value = parsed.ingredients;
        if (parsed.instructions) instEl.value = parsed.instructions;
        analyzeProgress.textContent = 'Done.';
      } catch (e) {
        console.error(e);
        analyzeProgress.textContent = 'Failed to analyze.';
      } finally {
        setTimeout(() => analyzeProgress.textContent = '', 1200);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      $('#saveBtn').disabled = true;
      $('#saveBtn').textContent = 'Saving...';

      const rec = {
        name: nameEl.value.trim(),
        category: catEl.value,
        ingredients: ingEl.value.trim(),
        instructions: instEl.value.trim(),
        rating: 0,
        createdAt: new Date().toISOString(),
      };

      // Read images to data URLs (so they're persisted in localStorage)
      if (finishedEl.files && finishedEl.files[0]) {
        rec.finishedPhoto = await fileToDataURL(finishedEl.files[0]).catch(()=>null);
      }
      if (photoEl.files && photoEl.files[0]) {
        rec.sourcePhoto = await fileToDataURL(photoEl.files[0]).catch(()=>null);
      }

      if (editingId) {
        const i = recipes.findIndex(r => r.__id === editingId);
        if (i >= 0) recipes[i] = { ...recipes[i], ...rec };
        editingId = null;
      } else {
        if (recipes.length >= 999) {
          alert('Maximum 999 recipes reached.');
          $('#saveBtn').disabled = false; $('#saveBtn').textContent = 'Save Recipe'; return;
        }
        rec.__id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
        recipes.push(rec);
      }
      save(recipes);
      closeModal();
      render();

      $('#saveBtn').disabled = false;
      $('#saveBtn').textContent = 'Save Recipe';
    });

    function openAdd(){
      editingId = null;
      modalTitle.textContent = 'Add New Recipe';
      form.reset();
      photoPreview.style.display = 'none';
      finishedPreview.style.display = 'none';
      modal.classList.add('active');
    }
    function openEdit(recipe){
      editingId = recipe.__id;
      modalTitle.textContent = 'Edit Recipe';
      nameEl.value = recipe.name || '';
      catEl.value = recipe.category || '';
      ingEl.value = recipe.ingredients || '';
      instEl.value = recipe.instructions || '';
      if (recipe.finishedPhoto){ finishedPreview.src = recipe.finishedPhoto; finishedPreview.style.display='block'; }
      else finishedPreview.style.display='none';
      modal.classList.add('active');
    }
    function closeModal(){ modal.classList.remove('active'); }

    function render(){
      limit.style.display = recipes.length >= 999 ? 'block' : 'none';

      const list = filter === 'all' ? recipes : recipes.filter(r => r.category === filter);
      if (!list.length){
        grid.innerHTML = `
          <div class="card text-center">
            <h2 class="text-xl m-0">No recipes yet!</h2>
            <p>Click ‚ÄúAdd New Recipe‚Äù to get started üç∞</p>
          </div>`;
        return;
      }
      grid.innerHTML = '';
      list.forEach(r => grid.appendChild(recipeCard(r)));
    }

    function recipeCard(r){
      const card = document.createElement('div');
      card.className = 'card';

      const photoTop = r.finishedPhoto
        ? `<div class="text-center mb-3"><img src="${r.finishedPhoto}" alt="Finished photo" style="max-width:100%;border-radius:10px;object-fit:cover"></div>`
        : '';

      card.innerHTML = `
        ${photoTop}
        <div class="flex items-start justify-between mb-2">
          <h3 class="m-0 text-lg" style="color:var(--text)">${esc(r.name)}</h3>
          <span class="chip">${esc(r.category || '')}</span>
        </div>

        <div class="rating" data-id="${r.__id}">
          ${[1,2,3,4,5].map(n => `<span class="star ${n<= (r.rating||0) ? 'filled':'empty'}" data-rating="${n}">‚òÖ</span>`).join('')}
        </div>

        <div class="mb-2">
          <h4 class="m-0 text-sm">Ingredients</h4>
          <p class="m-0 whitespace-pre-line">${esc(r.ingredients || '')}</p>
        </div>
        <div>
          <h4 class="m-0 text-sm">Instructions</h4>
          <p class="m-0 whitespace-pre-line">${esc(r.instructions || '')}</p>
        </div>

        <div class="grid grid-cols-2 gap-2 mt-3">
          <button class="btn btn-secondary edit">Edit</button>
          <button class="btn btn-primary delete" style="background:#f44336">Delete</button>
        </div>
      `;

      // Rating
      card.querySelector('.rating').addEventListener('click', (e) => {
        if (!e.target.classList.contains('star')) return;
        const rating = parseInt(e.target.getAttribute('data-rating'), 10);
        const i = recipes.findIndex(x => x.__id === r.__id);
        if (i >= 0){ recipes[i].rating = rating; save(recipes); render(); }
      });

      // Edit / Delete
      card.querySelector('.edit').addEventListener('click', () => openEdit(r));
      card.querySelector('.delete').addEventListener('click', () => confirmDelete(r));

      return card;
    }

    function confirmDelete(r){
      if (!confirm(`Delete "${r.name}"?`)) return;
      recipes = recipes.filter(x => x.__id !== r.__id);
      save(recipes);
      render();
    }

    /************ OCR helpers ************/
    async function fileToDataURL(file){
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = e => res(e.target.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });
    }
    function previewImage(input, imgEl){
      const f = input.files && input.files[0];
      if (!f){ imgEl.style.display='none'; return; }
      const fr = new FileReader();
      fr.onload = e => { imgEl.src = e.target.result; imgEl.style.display='block'; };
      fr.readAsDataURL(f);
    }
    async function ocrFile(file, onProgress){
      const dataUrl = await fileToDataURL(file);
      return new Promise((resolve, reject) => {
        Tesseract.recognize(dataUrl, 'eng', { logger: m => { if (onProgress && m.progress) onProgress(m.progress); } })
          .then(({ data:{ text } }) => resolve(text))
          .catch(reject);
      });
    }
    function parseText(text){
      const lines = (text || '').split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (!lines.length) return { name:'', ingredients:'', instructions:'' };
      let name = lines[0];
      const idxIng = lines.findIndex(l => /ingredient[s]?\b/i.test(l));
      const idxIns = lines.findIndex(l => /instruction[s]?\b|method\b|directions\b/i.test(l));
      let ingredients='', instructions='';
      if (idxIng >= 0 && idxIns >= 0){
        ingredients = lines.slice(idxIng+1, idxIns).join('\n');
        instructions = lines.slice(idxIns+1).join('\n');
      } else if (idxIns >= 0){
        ingredients = lines.slice(1, idxIns).join('\n');
        instructions = lines.slice(idxIns+1).join('\n');
      } else {
        const stepStart = lines.findIndex(l => /^\d+[\).]/.test(l));
        if (stepStart >= 0){
          ingredients = lines.slice(1, stepStart).join('\n');
          instructions = lines.slice(stepStart).join('\n');
        } else {
          const split = Math.max(1, Math.floor(lines.length/3));
          ingredients = lines.slice(1, split+1).join('\n');
          instructions = lines.slice(split+1).join('\n');
        }
      }
      if (!ingredients.trim()){
        const ingLines = lines.filter(l => /cup|tbsp|tsp|g\b|grams|oz|ml|pinch|kg|tablespoon|teaspoon/i.test(l));
        if (ingLines.length) ingredients = ingLines.join('\n');
      }
      return { name, ingredients, instructions };
    }
    async function ocrVideo(file, setStatus){
      const MAX = 3;
      const url = URL.createObjectURL(file);
      const video = document.getElementById('hiddenVideo');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      return new Promise((resolve, reject) => {
        const cleanup = () => { try{URL.revokeObjectURL(url);}catch{} video.pause(); video.removeAttribute('src'); };
        video.onloadedmetadata = async () => {
          const dur = video.duration || 0;
          if (!dur || !isFinite(dur)){ cleanup(); return reject(new Error('Bad video')); }
          const frames = Math.min(MAX, Math.ceil(dur));
          const times = Array.from({length:frames}, (_,i)=> (i+1)/(frames+1)*dur);
          let text = '';
          for (let i=0;i<times.length;i++){
            const t = times[i];
            setStatus && setStatus(`Frame ${i+1}/${frames}‚Ä¶`);
            await seek(video, t);
            canvas.width = Math.min(video.videoWidth, 1280);
            canvas.height = Math.min(video.videoHeight, 720);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
            try{
              const part = await ocrFile(blob);
              text += '\n' + part;
            }catch(e){ console.warn('frame OCR failed', e); }
          }
          cleanup();
          resolve(text);
        };
        video.onerror = () => { cleanup(); reject(new Error('Video load error')); };
        video.src = url;
        video.preload = 'metadata';
        video.muted = true;
      });
    }
    function seek(video, t){
      return new Promise((res) => {
        const onSeeked = () => { video.removeEventListener('seeked', onSeeked); res(); };
        video.addEventListener('seeked', onSeeked);
        video.currentTime = Math.min(Math.max(0,t), Math.max(0, (video.duration||0) - .1));
        setTimeout(() => { video.removeEventListener('seeked', onSeeked); res(); }, 3000); // fallback
      });
    }

    /************ Utility ************/
    function esc(s){ return String(s||'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

    /************ Boot ************/
    render();
  </script>
</body>
</html>
